# üéØ INSTRUCTIONS - Workspace v2.0

> **Principe**: Ce fichier **OVERRIDE** `.ai-core/`. Si non mentionn√© ici ‚Üí applique `.ai-core/` standards.

---

## üì¶ TECH STACK

```yaml
Backend:
  Language: TypeScript 5.3+ (strict mode - MANDATORY)
  Framework: Fastify 4.24+
  Database: SQLite3 5.1+ + Connection Pool (Phase 1) ‚Üí PostgreSQL 15+ (Phase 2)
  
Frontend:
  Language: Vanilla JS ES6+ (ou TypeScript optionnel)
  Framework: Web Components (standard)
  UI: HTML5 + CSS3
  
Runtime:
  Node.js 18+ LTS
  Electron 39+
  
Additional:
  Real-time: WebSocket (ws 8.18+)
  Auth: JWT 9.1+, BCRYPTJS 2.4.3+
  Security: Helmet 7.1+, CORS
  Build: tsx 4.7+ (dev), tsc (prod)
  Tests: Jest 29+, Supertest 6.3+

Interdit:
  - Express (remplac√© par Fastify)
  - React/Vue/Angular
  - better-sqlite3 (utiliser sqlite3 + pool)
  - CommonJS backend (utiliser ES6 modules)
  - GraphQL
  - Dark mode
```

---

## üé® DESIGN SYSTEM

id√©e design dashboard app serveur : Jarvis/src temp/dashboard.webp

```css
/* Couleurs principales */
--color-primary: #3E3B8C      /* Bleu principal */
--color-secondary: #2D3073    /* Bleu secondaire */
--color-accent-1: #F2BC1B     /* Jaune */
--color-accent-2: #F28241     /* Orange */
--color-bg: #f2f2f2           /* Blanc cass√© */
--color-text: #0D0D0D         /* Noir */
--color-error: #c62828        /* Erreur */
--color-valid: #008000        /* Succ√®s */

/* Spacing (syst√®me d'unit√©s - base 8px) */
--unit: 8px
--unit-1: 8px
--unit-2: 16px
--unit-3: 24px
--unit-4: 32px
--unit-5: 40px

/* Typography */
font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif

/* Autres */
--radius-small: 4px
--radius-medium: 8px
--shadow-small: rgba(0,0,0,0.24) 0px 3px 8px
--transition: all 0.3s ease
```

---

## üèóÔ∏è ARCHITECTURE

```yaml
Type: Monorepo (npm workspaces)

Structure:
  Backend: apps/server/src/{api,models,lib,ws,db,config,middleware,utils,types}
  Frontend: apps/client/public/{pages,components,assets}
  Tests: **/*.test.ts ou **/*.spec.ts

API Style:
  REST (Fastify) - endpoints /api/{resource}
  WebSocket (ws) - monitoring temps r√©el + chat

Database:
  Phase 1: SQLite3 + Connection Pool (5 connections max)
  Phase 2: PostgreSQL 15+ (migration pr√©vue)
  Abstraction: models/ layer pour faciliter migration
  
Module System:
  Backend: ES6 modules (import/export) + TypeScript
  Frontend: ES6 modules (import/export)
```

---

## üìù NAMING CONVENTIONS

```yaml
Backend TypeScript:
  Classes/Types: PascalCase (User, ChatManager, ApiResponse)
  Interfaces: PascalCase sans pr√©fixe I (User, Message)
  Functions: camelCase (getUser, processMessage)
  Constants: UPPER_SNAKE_CASE (MAX_LENGTH, JWT_SECRET)
  Files: PascalCase.ts (User.ts, ChatManager.ts)
  
Frontend JavaScript:
  Classes: PascalCase (ChatWidget)
  Functions: camelCase (handleMessage, setupChat)
  Files: camelCase.js (chatWidget.js, setupChat.js)
  
CSS:
  Classes: kebab-case (.chat-widget, .message-item)
  Variables: kebab-case (--primary-color, --unit-2)
  Files: kebab-case.css (chat-widget.css)

Database:
  Tables: snake_case (users, chat_messages)
  Columns: snake_case (user_id, created_at)
```

---

## üîê S√âCURIT√â

```yaml
Authentication:
  JWT (expiry: 7 jours, configurable via JWT_EXPIRY)
  Storage: localStorage (frontend), memory (backend)

Password Hashing:
  BCRYPT rounds ‚â• 12 (configurable via BCRYPT_ROUNDS)

Input Validation:
  Whitelist approach (validator.ts)
  Sanitization (sanitizers.ts)
  No SQL injection (prepared statements)
  No XSS (HTML escaping)

Headers:
  CORS: Whitelist uniquement
  CSP: Strict Content Security Policy
  Helmet: Toutes protections activ√©es
  TLS 1.3+ en production

Database:
  Connection pooling (√©vite locks)
  Timeout: 10 secondes max
  Prepared statements uniquement

Secrets:
  .env uniquement (JAMAIS dans le code)
  .gitignore: .env, *.key, *.pem
```

---

## üìÅ FOLDER STRUCTURE

```
workspace/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/              # Routes REST par module
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controller.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validator.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agenda/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts      # Export toutes les routes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/           # CRUD + logique m√©tier
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Event.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Message.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib/              # Utilitaires backend
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ password.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ errors.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ws/               # WebSocket handlers
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chatHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ monitorHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db/               # Database layer
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema.sql
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ connection.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pool.ts       # Connection pooling
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ env.ts        # Variables d'environnement
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validators.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sanitizers.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ formatters.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/            # Types TypeScript centralis√©s
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ websocket.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.ts           # Entry point
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ client/
‚îÇ       ‚îú‚îÄ‚îÄ public/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ pages/            # Pages HTML
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ home.html
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agenda.html
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ chat.html
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ components/       # Composants r√©utilisables
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.html
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ footer.html
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ChatWidget.html
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ assets/
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ css/
‚îÇ       ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ global.css
‚îÇ       ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ modules/
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ js/
‚îÇ       ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ global.js
‚îÇ       ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ       ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ modules/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ src/          # Images, icons, etc.
‚îÇ       ‚îî‚îÄ‚îÄ main.js               # Electron entry point
‚îú‚îÄ‚îÄ Jarvis/                       # Standards AI
‚îÇ   ‚îú‚îÄ‚îÄ .ai-core/
‚îÇ   ‚îî‚îÄ‚îÄ Instructions.mdc          # Ce fichier
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ tsconfig.json
```

---

## ‚öôÔ∏è CONFIGURATION

```bash
# .env
NODE_ENV=development
PORT=8060

# Database
DATABASE_PATH=./data/database.sqlite
DB_POOL_SIZE=5
DB_POOL_TIMEOUT=10000

# Security
JWT_SECRET=your-secret-key-change-in-production
JWT_EXPIRY=7d
BCRYPT_ROUNDS=12

# Features
ENABLE_CHAT=true
ENABLE_MONITORING=true
ENABLE_DEBUG=false
LOG_LEVEL=info

# Future: PostgreSQL (Phase 2)
# DB_HOST=localhost
# DB_PORT=5432
# DB_NAME=workspace
# DB_USER=postgres
# DB_PASSWORD=secret
```

**Configuration TypeScript** (`apps/server/src/config/env.ts`):
```typescript
import dotenv from 'dotenv';
dotenv.config();

interface Config {
  env: string;
  port: number;
  database: {
    path: string;
    poolSize: number;
    poolTimeout: number;
  };
  jwt: {
    secret: string;
    expiry: string;
  };
  bcrypt: {
    rounds: number;
  };
}

const config: Config = {
  env: process.env.NODE_ENV || 'development',
  port: parseInt(process.env.PORT || '8060', 10),
  database: {
    path: process.env.DATABASE_PATH || './data/database.sqlite',
    poolSize: parseInt(process.env.DB_POOL_SIZE || '5', 10),
    poolTimeout: parseInt(process.env.DB_POOL_TIMEOUT || '10000', 10),
  },
  jwt: {
    secret: process.env.JWT_SECRET || (
      process.env.NODE_ENV === 'production'
        ? (() => { throw new Error('JWT_SECRET required in production'); })()
        : 'dev-secret'
    ),
    expiry: process.env.JWT_EXPIRY || '7d',
  },
  bcrypt: {
    rounds: parseInt(process.env.BCRYPT_ROUNDS || '12', 10),
  },
};

export default config;
```

---

## üß™ QUALIT√â

```yaml
Tests:
  Coverage: 80%+ (global), 100% (auth + validation)
  Framework: Jest 29+
  API Testing: Supertest 6.3+
  Files: *.test.ts ou *.spec.ts
  
Linting:
  ESLint 8+ (enforced)
  Prettier 3+ (auto-format)
  
Type Safety:
  TypeScript strict mode (backend)
  No 'any' type (sauf cas justifi√©s avec commentaire)
  Tous les param√®tres et retours typ√©s
  
Pre-commit checks:
  - npm run lint          # ESLint
  - npm run type-check    # TypeScript compilation
  - npm run test          # Jest tests
  - Coverage > 80%
```

**Scripts package.json**:
```json
{
  "scripts": {
    "dev": "concurrently \"npm run dev:server\" \"npm run dev:client\"",
    "dev:server": "tsx watch apps/server/src/main.ts",
    "dev:client": "electron apps/client/main.js",
    "build": "tsc --project apps/server/tsconfig.json",
    "start": "node apps/server/dist/main.js",
    "test": "jest --coverage",
    "lint": "eslint \"apps/**/*.ts\" --fix",
    "format": "prettier --write \"apps/**/*.{ts,js,css,json}\"",
    "type-check": "tsc --noEmit"
  }
}
```

---

## üéØ DECISION TREES

### Cr√©ation de fichier/dossier

```
Question: O√π cr√©er le nouveau fichier ?

‚îú‚îÄ Backend logic ?
‚îÇ  ‚îú‚îÄ Route API ?           ‚Üí apps/server/src/api/{module}/routes.ts
‚îÇ  ‚îú‚îÄ Business logic ?      ‚Üí apps/server/src/models/{Entity}.ts
‚îÇ  ‚îú‚îÄ Utility ?             ‚Üí apps/server/src/lib/{utility}.ts
‚îÇ  ‚îú‚îÄ WebSocket handler ?   ‚Üí apps/server/src/ws/handlers/{handler}.ts
‚îÇ  ‚îú‚îÄ Database ?            ‚Üí apps/server/src/db/{connection|pool}.ts
‚îÇ  ‚îî‚îÄ Middleware ?          ‚Üí apps/server/src/middleware/{name}.ts
‚îÇ
‚îú‚îÄ Frontend UI ?
‚îÇ  ‚îú‚îÄ Page compl√®te ?       ‚Üí apps/client/public/pages/{page}.html
‚îÇ  ‚îú‚îÄ Composant ?           ‚Üí apps/client/public/components/{component}.html
‚îÇ  ‚îú‚îÄ Style ?               ‚Üí apps/client/public/assets/css/{module}.css
‚îÇ  ‚îî‚îÄ Script ?              ‚Üí apps/client/public/assets/js/{module}.js
‚îÇ
‚îú‚îÄ Configuration ?
‚îÇ  ‚îú‚îÄ Env variables ?       ‚Üí apps/server/src/config/env.ts
‚îÇ  ‚îî‚îÄ Shared config ?       ‚Üí Root .env
‚îÇ
‚îî‚îÄ Types TypeScript ?       ‚Üí apps/server/src/types/{category}.ts
```

### Checklist avant commit

```
Avant chaque commit:
- [ ] Pas de console.log() (utiliser logger)
- [ ] Pas de valeurs hardcod√©es (utiliser config)
- [ ] Pas de 'any' type (backend TypeScript)
- [ ] Tous les param√®tres typ√©s (backend)
- [ ] Pas de secrets dans le code (.env only)
- [ ] ESLint passe: npm run lint
- [ ] TypeScript compile: npm run type-check
- [ ] Tests passent: npm run test
- [ ] Coverage > 80%
- [ ] TSDoc sur fonctions publiques (backend)
- [ ] Pas de code mort
- [ ] Queries DB utilisent le pool
```

### Git Workflow

```
Branches:
  feature/{description}   # Nouvelle fonctionnalit√©
  bugfix/{description}    # Correction de bug
  refactor/{description}  # Refactoring code
  docs/{description}      # Documentation

Commits:
  feat: Ajouter nouvelle feature
  fix: Corriger bug
  refactor: Am√©liorer code
  docs: Mettre √† jour docs
  test: Ajouter tests
  chore: Maintenance
```

---

## üîß TypeScript Configuration

**tsconfig.json (Backend)**:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "**/*.test.ts"]
}
```

---

## üìö R√âF√âRENCES

> **Tout ce qui n'est pas sp√©cifi√© ci-dessus** ‚Üí Voir `.ai-core/` pour les standards g√©n√©raux:
> - `.ai-core/standards.json` - Standards techniques
> - `.ai-core/rules.json` - R√®gles de validation
> - `.ai-core/patterns.json` - Design patterns
> - `.ai-core/workflow.json` - Workflows de d√©veloppement

**Documentation projet**:
- `README.md` - Vue d'ensemble
- `docs/` - Documentation d√©taill√©e
- `CHANGELOG.md` - Historique des versions
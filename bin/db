#!/usr/bin/env bash
set -euo pipefail
DB="./data/database.sqlite"

get_migration() {
    for f in ./migrations/init.sql ./migrations/schema.sql ./migrations/sqlite_init.sql ./migrations/tables.sql; do
        [[ -f "$f" ]] && echo "$f" && return 0
    done
    return 1
}

mkdir -p ./data
case "${1:-}" in
  init)  
    if mig=$(get_migration); then
      : > "$DB"
      sqlite3 "$DB" < "$mig"
      echo "✅ DB initialized at $DB"
    else
      : > "$DB"
      echo "⚠️  DB créée vide (pas de migration trouvée)"
    fi
    ;;
  reset) 
    if mig=$(get_migration); then
      rm -f "$DB"
      sqlite3 "$DB" < "$mig"
      echo "✅ DB reset"
    else
      echo "❌ Pas de migration trouvée" >&2
      exit 1
    fi
    ;;
  shell) sqlite3 "$DB" ;;
  backup)
    mkdir -p ./data/backups
    ts=$(date +%Y%m%d_%H%M%S)
    cp "$DB" "./data/backups/database_$ts.sqlite"
    echo "✅ Backup: ./data/backups/database_$ts.sqlite"
    ;;
  *) echo "Usage: bin/db {init|reset|shell|backup}" >&2; exit 1;;
esac
